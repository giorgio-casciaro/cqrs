'use strict';

var R = require('ramda');
var path = require('path');

var fs = require('fs');
var PACKAGE = 'mutations.cqrs';
var checkRequired = require('./utils').checkRequired;
var checkRequiredFiles = require('./utils').checkRequiredFiles;
var uuidV4 = require('uuid/v4');
var getConsole = function getConsole(serviceName, serviceId, pack) {
  return require('./utils').getConsole({ error: true, debug: true, log: true, warn: true }, serviceName, serviceId, pack);
};

function getMutationsFunctions(basePath) {
  var filesJsNoExtension = R.map(R.compose(R.replace('.js', ''), path.basename), R.filter(function (file) {
    return path.extname(file) === '.js';
  }, fs.readdirSync(basePath)));
  var splitFiles = R.map(R.split('.'));
  var sortFiles = R.compose(R.reverse, R.sortBy(R.compose(parseInt, R.prop(0))));
  var groupFiles = R.groupBy(R.prop(0));
  var addFunction = R.map(R.map(function (element) {
    return { mutationId: element[0], mutationVersion: element[1] };
  }));
  var mutationsFunctions = R.compose(addFunction, groupFiles, sortFiles, splitFiles)(filesJsNoExtension);
  // debug('getMutationsFunctions', mutationsFunctions)
  return mutationsFunctions;
}

function checkMutationFunction(mutationId, mutationsFunctions) {
  if (!mutationsFunctions[mutationId] || !mutationsFunctions[mutationId][0]) {
    errorThrow('mutation not defined', { mutationId: mutationId });
  }
}

function generateId() {
  return uuidV4();
}
module.exports = function getMutationsCqrsPackage(_ref) {
  var _ref$serviceName = _ref.serviceName,
      serviceName = _ref$serviceName === undefined ? 'unknow' : _ref$serviceName,
      _ref$serviceId = _ref.serviceId,
      serviceId = _ref$serviceId === undefined ? 'unknow' : _ref$serviceId,
      mutationsPath = _ref.mutationsPath;

  var CONSOLE = getConsole(serviceName, serviceId, PACKAGE);
  var errorThrow = require('./utils').errorThrow(serviceName, serviceId, PACKAGE);

  var applyMutationsFromPath = function applyMutationsFromPathFunc(originalState, mutations, mutationsPath) {
    var state = R.clone(originalState);
    CONSOLE.debug('applyMutationsFromPath', { state: state, mutations: mutations, mutationsPath: mutationsPath });
    function applyMutation(state, mutation) {
      var mutationFile = path.join(mutationsPath, mutation.mutation + '.' + mutation.version + '.js');
      CONSOLE.debug('applyMutation', { mutationFile: mutationFile, state: state, data: mutation.data });
      return require(mutationFile)(state, mutation.data);
    }
    return R.reduce(applyMutation, state, mutations);
  };

  try {
    checkRequired({ mutationsPath: mutationsPath }, PACKAGE);
    checkRequiredFiles([mutationsPath], PACKAGE);
    return {
      mutate: function mutate(_ref2) {
        var mutation = _ref2.mutation,
            objId = _ref2.objId,
            data = _ref2.data,
            meta = _ref2.meta;

        try {
          checkRequired({ objId: objId, mutation: mutation }, PACKAGE);
          var mutationsFunctions = getMutationsFunctions(mutationsPath);
          checkMutationFunction(mutation, mutationsFunctions);
          var lastMutationVersion = mutationsFunctions[mutation][0].mutationVersion;
          var mutationState = {
            objId: objId,
            _id: generateId(),
            mutation: mutation,
            meta: meta,
            version: lastMutationVersion,
            timestamp: new Date().getTime(),
            data: data
          };
          CONSOLE.debug('dataSingleMutation to create', { mutation: mutation, lastMutationVersion: lastMutationVersion, objId: objId, data: data, mutationState: mutationState });
          return mutationState;
        } catch (error) {
          errorThrow('mutate(args) Error', { error: error, mutation: mutation, objId: objId, data: data });
        }
      },
      applyMutations: function applyMutations(state, mutations) {
        CONSOLE.debug('applyMutationsFromPath', { state: state, mutations: mutations, mutationsPath: mutationsPath });
        return applyMutationsFromPath(state, mutations, mutationsPath);
      }
    };
  } catch (error) {
    errorThrow('getMutationsCqrsPackage', { error: error, mutationsPath: mutationsPath });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm11dGF0aW9ucy5lczYiXSwibmFtZXMiOlsiUiIsInJlcXVpcmUiLCJwYXRoIiwiZnMiLCJQQUNLQUdFIiwiY2hlY2tSZXF1aXJlZCIsImNoZWNrUmVxdWlyZWRGaWxlcyIsInV1aWRWNCIsImdldENvbnNvbGUiLCJzZXJ2aWNlTmFtZSIsInNlcnZpY2VJZCIsInBhY2siLCJlcnJvciIsImRlYnVnIiwibG9nIiwid2FybiIsImdldE11dGF0aW9uc0Z1bmN0aW9ucyIsImJhc2VQYXRoIiwiZmlsZXNKc05vRXh0ZW5zaW9uIiwibWFwIiwiY29tcG9zZSIsInJlcGxhY2UiLCJiYXNlbmFtZSIsImZpbHRlciIsImZpbGUiLCJleHRuYW1lIiwicmVhZGRpclN5bmMiLCJzcGxpdEZpbGVzIiwic3BsaXQiLCJzb3J0RmlsZXMiLCJyZXZlcnNlIiwic29ydEJ5IiwicGFyc2VJbnQiLCJwcm9wIiwiZ3JvdXBGaWxlcyIsImdyb3VwQnkiLCJhZGRGdW5jdGlvbiIsImVsZW1lbnQiLCJtdXRhdGlvbklkIiwibXV0YXRpb25WZXJzaW9uIiwibXV0YXRpb25zRnVuY3Rpb25zIiwiY2hlY2tNdXRhdGlvbkZ1bmN0aW9uIiwiZXJyb3JUaHJvdyIsImdlbmVyYXRlSWQiLCJtb2R1bGUiLCJleHBvcnRzIiwiZ2V0TXV0YXRpb25zQ3Fyc1BhY2thZ2UiLCJtdXRhdGlvbnNQYXRoIiwiQ09OU09MRSIsImFwcGx5TXV0YXRpb25zRnJvbVBhdGgiLCJhcHBseU11dGF0aW9uc0Zyb21QYXRoRnVuYyIsIm9yaWdpbmFsU3RhdGUiLCJtdXRhdGlvbnMiLCJzdGF0ZSIsImNsb25lIiwiYXBwbHlNdXRhdGlvbiIsIm11dGF0aW9uIiwibXV0YXRpb25GaWxlIiwiam9pbiIsInZlcnNpb24iLCJkYXRhIiwicmVkdWNlIiwibXV0YXRlIiwib2JqSWQiLCJtZXRhIiwibGFzdE11dGF0aW9uVmVyc2lvbiIsIm11dGF0aW9uU3RhdGUiLCJfaWQiLCJ0aW1lc3RhbXAiLCJEYXRlIiwiZ2V0VGltZSIs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Q0FBUDtBQUNEO0FBekJJLEtBQVA7QUEyQkQsR0E5QkQsQ0E4QkUsT0FBT25DLEtBQVAsRUFBYztBQUNkOEIsZUFBVyx5QkFBWCxFQUFzQyxFQUFDOUIsWUFBRCxFQUFRbUMsNEJBQVIsRUFBdEM7QUFDRDtBQUNGLENBaEREIiwiZmlsZSI6Im11dGF0aW9ucy5lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgUiA9IHJlcXVpcmUoJ3JhbWRhJylcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJylcbmNvbnN0IFBBQ0tBR0UgPSAnbXV0YXRpb25zLmNxcnMnXG5jb25zdCBjaGVja1JlcXVpcmVkID0gcmVxdWlyZSgnLi91dGlscycpLmNoZWNrUmVxdWlyZWRcbnZhciBjaGVja1JlcXVpcmVkRmlsZXMgPSByZXF1aXJlKCcuL3V0aWxzJykuY2hlY2tSZXF1aXJlZEZpbGVzXG5jb25zdCB1dWlkVjQgPSByZXF1aXJlKCd1dWlkL3Y0JylcbmNvbnN0IGdldENvbnNvbGUgPSAoc2VydmljZU5hbWUsIHNlcnZpY2VJZCwgcGFjaykgPT4gcmVxdWlyZSgnLi91dGlscycpLmdldENvbnNvbGUoe2Vycm9yOiB0cnVlLCBkZWJ1ZzogdHJ1ZSwgbG9nOiB0cnVlLCB3YXJuOiB0cnVlfSwgc2VydmljZU5hbWUsIHNlcnZpY2VJZCwgcGFjaylcblxuZnVuY3Rpb24gZ2V0TXV0YXRpb25zRnVuY3Rpb25zIChiYXNlUGF0aCkge1xuICB2YXIgZmlsZXNKc05vRXh0ZW5zaW9uID0gUi5tYXAoUi5jb21wb3NlKFIucmVwbGFjZSgnLmpzJywgJycpLCBwYXRoLmJhc2VuYW1lKSwgUi5maWx0ZXIoKGZpbGUpID0+IHBhdGguZXh0bmFtZShmaWxlKSA9PT0gJy5qcycsIGZzLnJlYWRkaXJTeW5jKGJhc2VQYXRoKSkpXG4gIHZhciBzcGxpdEZpbGVzID0gUi5tYXAoUi5zcGxpdCgnLicpKVxuICB2YXIgc29ydEZpbGVzID0gUi5jb21wb3NlKFIucmV2ZXJzZSwgUi5zb3J0QnkoUi5jb21wb3NlKHBhcnNlSW50LCBSLnByb3AoMCkpKSlcbiAgdmFyIGdyb3VwRmlsZXMgPSBSLmdyb3VwQnkoUi5wcm9wKDApKVxuICB2YXIgYWRkRnVuY3Rpb24gPSBSLm1hcChSLm1hcCgoZWxlbWVudCkgPT4ge1xuICAgIHJldHVybiB7bXV0YXRpb25JZDogZWxlbWVudFswXSwgbXV0YXRpb25WZXJzaW9uOiBlbGVtZW50WzFdfVxuICB9KSlcbiAgdmFyIG11dGF0aW9uc0Z1bmN0aW9ucyA9IFIuY29tcG9zZShhZGRGdW5jdGlvbiwgZ3JvdXBGaWxlcywgc29ydEZpbGVzLCBzcGxpdEZpbGVzKShmaWxlc0pzTm9FeHRlbnNpb24pXG4gIC8vIGRlYnVnKCdnZXRNdXRhdGlvbnNGdW5jdGlvbnMnLCBtdXRhdGlvbnNGdW5jdGlvbnMpXG4gIHJldHVybiBtdXRhdGlvbnNGdW5jdGlvbnNcbn1cblxuZnVuY3Rpb24gY2hlY2tNdXRhdGlvbkZ1bmN0aW9uIChtdXRhdGlvbklkLCBtdXRhdGlvbnNGdW5jdGlvbnMpIHtcbiAgaWYgKCFtdXRhdGlvbnNGdW5jdGlvbnNbbXV0YXRpb25JZF0gfHwgIW11dGF0aW9uc0Z1bmN0aW9uc1ttdXRhdGlvbklkXVswXSkge1xuICAgIGVycm9yVGhyb3coJ211dGF0aW9uIG5vdCBkZWZpbmVkJywge211dGF0aW9uSWR9KVxuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlSWQgKCkgeyByZXR1cm4gdXVpZFY0KCkgfVxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBnZXRNdXRhdGlvbnNDcXJzUGFja2FnZSAoe3NlcnZpY2VOYW1lID0gJ3Vua25vdycsIHNlcnZpY2VJZCA9ICd1bmtub3cnLCBtdXRhdGlvbnNQYXRofSkge1xuICB2YXIgQ09OU09MRSA9IGdldENvbnNvbGUoc2VydmljZU5hbWUsIHNlcnZpY2VJZCwgUEFDS0FHRSlcbiAgdmFyIGVycm9yVGhyb3cgPSByZXF1aXJlKCcuL3V0aWxzJykuZXJyb3JUaHJvdyhzZXJ2aWNlTmFtZSwgc2VydmljZUlkLCBQQUNLQUdFKVxuXG4gIHZhciBhcHBseU11dGF0aW9uc0Zyb21QYXRoID0gZnVuY3Rpb24gYXBwbHlNdXRhdGlvbnNGcm9tUGF0aEZ1bmMgKG9yaWdpbmFsU3RhdGUsIG11dGF0aW9ucywgbXV0YXRpb25zUGF0aCkge1xuICAgIHZhciBzdGF0ZSA9IFIuY2xvbmUob3JpZ2luYWxTdGF0ZSlcbiAgICBDT05TT0xFLmRlYnVnKCdhcHBseU11dGF0aW9uc0Zyb21QYXRoJywge3N0YXRlLCBtdXRhdGlvbnMsIG11dGF0aW9uc1BhdGh9KVxuICAgIGZ1bmN0aW9uIGFwcGx5TXV0YXRpb24gKHN0YXRlLCBtdXRhdGlvbikge1xuICAgICAgdmFyIG11dGF0aW9uRmlsZSA9IHBhdGguam9pbihtdXRhdGlvbnNQYXRoLCBgJHttdXRhdGlvbi5tdXRhdGlvbn0uJHttdXRhdGlvbi52ZXJzaW9ufS5qc2ApXG4gICAgICBDT05TT0xFLmRlYnVnKCdhcHBseU11dGF0aW9uJywge211dGF0aW9uRmlsZSwgc3RhdGUsIGRhdGE6IG11dGF0aW9uLmRhdGF9KVxuICAgICAgcmV0dXJuIHJlcXVpcmUobXV0YXRpb25GaWxlKShzdGF0ZSwgbXV0YXRpb24uZGF0YSlcbiAgICB9XG4gICAgcmV0dXJuIFIucmVkdWNlKGFwcGx5TXV0YXRpb24sIHN0YXRlLCBtdXRhdGlvbnMpXG4gIH1cblxuICB0cnkge1xuICAgIGNoZWNrUmVxdWlyZWQoe211dGF0aW9uc1BhdGh9LCBQQUNLQUdFKVxuICAgIGNoZWNrUmVxdWlyZWRGaWxlcyhbbXV0YXRpb25zUGF0aF0sIFBBQ0tBR0UpXG4gICAgcmV0dXJuIHtcbiAgICAgIG11dGF0ZTogZnVuY3Rpb24gbXV0YXRlICh7bXV0YXRpb24sIG9iaklkLCBkYXRhLCBtZXRhfSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNoZWNrUmVxdWlyZWQoe29iaklkLCBtdXRhdGlvbn0sIFBBQ0tBR0UpXG4gICAgICAgICAgdmFyIG11dGF0aW9uc0Z1bmN0aW9ucyA9IGdldE11dGF0aW9uc0Z1bmN0aW9ucyhtdXRhdGlvbnNQYXRoKVxuICAgICAgICAgIGNoZWNrTXV0YXRpb25GdW5jdGlvbihtdXRhdGlvbiwgbXV0YXRpb25zRnVuY3Rpb25zKVxuICAgICAgICAgIHZhciBsYXN0TXV0YXRpb25WZXJzaW9uID0gbXV0YXRpb25zRnVuY3Rpb25zW211dGF0aW9uXVswXS5tdXRhdGlvblZlcnNpb25cbiAgICAgICAgICB2YXIgbXV0YXRpb25TdGF0ZSA9IHtcbiAgICAgICAgICAgIG9iaklkOiBvYmpJZCxcbiAgICAgICAgICAgIF9pZDogZ2VuZXJhdGVJZCgpLFxuICAgICAgICAgICAgbXV0YXRpb24sXG4gICAgICAgICAgICBtZXRhLFxuICAgICAgICAgICAgdmVyc2lvbjogbGFzdE11dGF0aW9uVmVyc2lvbixcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksXG4gICAgICAgICAgICBkYXRhXG4gICAgICAgICAgfVxuICAgICAgICAgIENPTlNPTEUuZGVidWcoJ2RhdGFTaW5nbGVNdXRhdGlvbiB0byBjcmVhdGUnLCB7bXV0YXRpb24sIGxhc3RNdXRhdGlvblZlcnNpb24sIG9iaklkLCBkYXRhLCBtdXRhdGlvblN0YXRlfSlcbiAgICAgICAgICByZXR1cm4gbXV0YXRpb25TdGF0ZVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGVycm9yVGhyb3coJ211dGF0ZShhcmdzKSBFcnJvcicsIHtlcnJvciwgbXV0YXRpb24sIG9iaklkLCBkYXRhfSlcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGFwcGx5TXV0YXRpb25zOiBmdW5jdGlvbiBhcHBseU11dGF0aW9ucyAoc3RhdGUsIG11dGF0aW9ucykge1xuICAgICAgICBDT05TT0xFLmRlYnVnKCdhcHBseU11dGF0aW9uc0Zyb21QYXRoJywge3N0YXRlLCBtdXRhdGlvbnMsIG11dGF0aW9uc1BhdGh9KVxuICAgICAgICByZXR1cm4gYXBwbHlNdXRhdGlvbnNGcm9tUGF0aChzdGF0ZSwgbXV0YXRpb25zLCBtdXRhdGlvbnNQYXRoKVxuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBlcnJvclRocm93KCdnZXRNdXRhdGlvbnNDcXJzUGFja2FnZScsIHtlcnJvciwgbXV0YXRpb25zUGF0aH0pXG4gIH1cbn1cbiJdfQ==